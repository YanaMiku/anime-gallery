<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnimeGallery - Image Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tambahkan LordIcon -->
    <script src="https://cdn.lordicon.com/lordicon.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        /* PERUBAHAN: CSS untuk menghilangkan efek seleksi biru dan highlight */
        /* Hilangkan highlight saat tap/click pada elemen */
        * {
            -webkit-tap-highlight-color: transparent;
            tap-highlight-color: transparent;
        }
        
        /* Hilangkan highlight seleksi teks */
        ::selection {
            background-color: transparent;
            color: inherit;
        }
        
        ::-moz-selection {
            background-color: transparent;
            color: inherit;
        }
        
        /* Untuk browser WebKit (Chrome, Safari, Edge) */
        *:focus {
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Untuk Firefox */
        *:focus-visible {
            outline: none;
        }
        
        /* Untuk input, textarea, button tetap memiliki indikator fokus yang diperlukan untuk aksesibilitas */
        input:focus,
        textarea:focus,
        select:focus,
        button:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        
        /* Hilangkan highlight pada dropdown items saat aktif */
        .dropdown-item:active,
        .dropdown-item:focus {
            background-color: rgba(59, 130, 246, 0.1);
            outline: none;
        }
        
        .dark .dropdown-item:active,
        .dark .dropdown-item:focus {
            background-color: rgba(59, 130, 246, 0.2);
        }
        
        /* Hilangkan highlight pada tombol modal */
        .modal-close:active,
        .modal-close:focus,
        .modal-nav:active,
        .modal-nav:focus,
        .modal-download:active,
        .modal-download:focus {
            outline: none;
            box-shadow: none;
        }
        
        /* Glassmorphism effect for navbar */
        .glass-navbar {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        
        .dark .glass-navbar {
            background: rgba(31, 41, 55, 0.35);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.18);
        }

        .grid-item {
            transition: transform 0.3s ease;
            width: 100%;
        }
        
        .grid-item:hover {
            transform: scale(1.02);
            z-index: 5;
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0f0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        .dark .skeleton {
            background: linear-gradient(90deg, #2d2d2d 25%, #3d3d3d 50%, #2d2d2d 75%);
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Container menggunakan Flex untuk kolom */
        .masonry-wrapper {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .masonry-column {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            flex: 1;
            min-width: 0; /* Mencegah overflow pada flex child */
        }

        #back-to-top {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        #back-to-top:hover {
            transform: translateY(-4px);
        }

        /* Custom dropdown styles */
        .category-dropdown {
            position: relative;
        }
        
        /* Dropdown batch size */
        .batch-dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 50;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 0.75rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 0 8px 32px rgba(31, 38, 135, 0.15);
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 0;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .dark .dropdown-menu {
            background: rgba(55, 65, 81, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 8px 32px rgba(0, 0, 0, 0.25);
        }

        .dropdown-menu.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(8px);
            max-height: 400px;
            overflow-y: auto;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
            gap: 0.75rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .dark .dropdown-item {
            color: #d1d5db;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .dropdown-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .dark .dropdown-item:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        .dropdown-item.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(168, 85, 247, 0.1));
            color: #3b82f6;
            position: relative;
        }

        .dark .dropdown-item.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(168, 85, 247, 0.2));
            color: #93c5fd;
        }

        .dropdown-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, #3b82f6, #8b5cf6);
            border-radius: 0 2px 2px 0;
        }

        .dropdown-header {
            padding: 1rem;
            font-size: 0.875rem;
            font-weight: 700;
            color: #6b7280;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            background: rgba(255, 255, 255, 0.6);
            letter-spacing: 0.5px;
        }

        .dark .dropdown-header {
            color: #9ca3af;
            border-bottom-color: rgba(255, 255, 255, 0.1);
            background: rgba(31, 41, 55, 0.6);
        }

        /* Dropdown scrollbar styling */
        .dropdown-menu::-webkit-scrollbar {
            width: 8px;
        }

        .dropdown-menu::-webkit-scrollbar-track {
            background: rgba(241, 241, 241, 0.5);
            border-radius: 4px;
            margin: 4px 0;
        }

        .dark .dropdown-menu::-webkit-scrollbar-track {
            background: rgba(75, 85, 99, 0.5);
        }

        .dropdown-menu::-webkit-scrollbar-thumb {
            background: rgba(156, 163, 175, 0.6);
            border-radius: 4px;
        }

        .dark .dropdown-menu::-webkit-scrollbar-thumb {
            background: rgba(107, 114, 128, 0.6);
        }

        .dropdown-menu::-webkit-scrollbar-thumb:hover {
            background: rgba(107, 114, 128, 0.8);
        }

        .dark .dropdown-menu::-webkit-scrollbar-thumb:hover {
            background: rgba(156, 163, 175, 0.8);
        }

        /* Image preview modal styles */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.92);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .image-modal.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            background: transparent;
            border-radius: 1rem;
            overflow: hidden;
        }

        .modal-image {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            display: block;
            border-radius: 0.5rem;
        }

        /* PERUBAHAN: Tombol close di pojok kanan atas dengan posisi fixed */
        .modal-close {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.25rem;
            transition: all 0.2s ease;
            z-index: 110;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .modal-close:hover {
            background: rgba(220, 38, 38, 0.8);
            transform: rotate(90deg);
        }

        .modal-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.85), transparent);
            color: white;
            padding: 1.75rem 1.5rem 1.25rem;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .modal-content:hover .modal-info {
            transform: translateY(0);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            letter-spacing: 0.5px;
        }

        .modal-category {
            font-size: 0.875rem;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* PERUBAHAN: Tombol prev/next di tepi dengan posisi fixed dan jarak */
        .modal-nav {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 3.5rem;
            height: 3.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.2s ease;
            z-index: 110;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .modal-nav.prev {
            left: 2rem;
        }

        .modal-nav.next {
            right: 2rem;
        }

        .modal-nav:hover {
            background: rgba(59, 130, 246, 0.9);
            transform: translateY(-50%) scale(1.1);
        }

        .modal-nav.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .modal-nav.disabled:hover {
            background: rgba(0, 0, 0, 0.7);
            transform: translateY(-50%);
        }

        /* Loading animation for modal */
        .modal-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 60vh;
        }

        .modal-loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 60px;
            height: 60px;
            animation: modal-spin 1.2s linear infinite;
        }

        @keyframes modal-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Download button in modal */
        .modal-download {
            position: absolute;
            bottom: 1.5rem;
            right: 1.5rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(139, 92, 246, 0.9));
            color: white;
            border: none;
            border-radius: 50%;
            width: 3.25rem;
            height: 3.25rem;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.3s ease;
            z-index: 101;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .modal-download span {
            display: none;
        }

        .modal-download i {
            font-size: 1.25rem;
        }

        .modal-download:hover {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.95), rgba(124, 58, 237, 0.9));
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        /* Glass effect for buttons */
        .glass-button {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .dark .glass-button {
            background: rgba(55, 65, 81, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .glass-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .dark .glass-button:hover {
            background: rgba(75, 85, 99, 0.5);
            border-color: rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        /* PERUBAHAN: Tombol back-to-top menjadi bulat sempurna */
        #back-to-top {
            border-radius: 50%;
            width: 3.5rem;
            height: 3.5rem;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* PERUBAHAN: Tombol theme toggle menjadi bulat sempurna TANPA TEKS di semua ukuran */
        #theme-toggle {
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Theme icon container */
        #theme-icon-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        #theme-icon-container lord-icon {
            width: 24px !important;
            height: 24px !important;
        }
        
        /* PERUBAHAN: Tombol preview di tengah gambar - UKURAN DIPERKECIL */
        .preview-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .grid-item:hover .preview-overlay {
            opacity: 1;
        }
        
        .preview-icon-container {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            border-radius: 50%;
            padding: 0.4rem;
            transition: all 0.3s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .grid-item:hover .preview-icon-container {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.25);
        }
        
        /* PERUBAHAN: Ukuran LordIcon yang lebih kecil */
        .preview-icon-container lord-icon {
            width: 24px !important;
            height: 24px !important;
        }
        
        /* PERUBAHAN: Styling untuk logo di header */
        .header-logo {
            width: 32px;
            height: 32px;
        }
        
        /* PERUBAHAN: Style untuk tombol navbar di mobile - UKURAN DIPERKECIL */
        .mobile-nav-button {
            padding: 0.5rem 0.75rem !important;
            font-size: 0.75rem !important;
            height: auto !important;
            min-height: 40px !important;
        }
        
        .mobile-nav-button i {
            font-size: 0.75rem !important;
        }
        
        .mobile-nav-button span {
            font-size: 0.75rem !important;
        }
        
        .mobile-theme-button {
            width: 2.5rem !important;
            height: 2.5rem !important;
            min-width: 2.5rem !important;
            min-height: 2.5rem !important;
        }
        
        #theme-icon-container lord-icon {
            width: 18px !important;
            height: 18px !important;
        }
        
        .mobile-logo {
            font-size: 1rem !important;
        }
        
        .mobile-header-logo {
            width: 24px !important;
            height: 24px !important;
        }
        
        /* Mobile dropdown adjustments */
        .mobile-dropdown {
            font-size: 0.75rem !important;
        }
        
        .mobile-dropdown .dropdown-item {
            padding: 0.5rem 0.75rem !important;
            font-size: 0.75rem !important;
        }
        
        .mobile-dropdown .dropdown-header {
            padding: 0.75rem !important;
            font-size: 0.75rem !important;
        }
        
        @media (min-width: 640px) {
            .header-logo {
                width: 36px;
                height: 36px;
            }
            
            /* PERUBAHAN: Jarak tombol modal di layar lebih besar */
            .modal-close {
                top: 2.5rem;
                right: 2.5rem;
            }
            
            .modal-nav.prev {
                left: 2.5rem;
            }
            
            .modal-nav.next {
                right: 2.5rem;
            }
        }
        
        @media (min-width: 1024px) {
            /* PERUBAHAN: Jarak tombol modal di layar desktop lebih besar */
            .modal-close {
                top: 3rem;
                right: 3rem;
            }
            
            .modal-nav.prev {
                left: 3rem;
            }
            
            .modal-nav.next {
                right: 3rem;
            }
        }
        
        /* PERUBAHAN: Media query untuk mobile dengan breakpoint yang lebih spesifik */
        @media (max-width: 639px) {
            .glass-navbar {
                padding-top: 0.75rem;
                padding-bottom: 0.75rem;
            }
            
            /* Perkecil gap antar elemen di navbar */
            .flex.gap-3 {
                gap: 0.5rem !important;
            }
            
            .flex.gap-2 {
                gap: 0.375rem !important;
            }
            
            /* Perkecil ukuran tombol dropdown */
            .category-dropdown,
            .batch-dropdown {
                width: 100%;
                max-width: 140px;
            }
            
            /* Perkecil padding pada tombol navbar */
            #category-toggle,
            #batch-toggle {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.75rem !important;
            }
            
            #category-toggle i,
            #batch-toggle i {
                font-size: 0.75rem !important;
            }
            
            #category-toggle span,
            #batch-toggle span {
                font-size: 0.75rem !important;
            }
            
            /* Perkecil ukuran tombol tema */
            #theme-toggle {
                width: 2.5rem !important;
                height: 2.5rem !important;
                min-width: 2.5rem !important;
                min-height: 2.5rem !important;
            }
            
            #theme-icon-container lord-icon {
                width: 18px !important;
                height: 18px !important;
            }
            
            /* Perkecil logo dan judul */
            h1 {
                font-size: 1.125rem !important;
            }
            
            .header-logo {
                width: 24px !important;
                height: 24px !important;
            }
            
            /* Perkecil ukuran dropdown menu untuk mobile */
            .dropdown-menu {
                font-size: 0.75rem;
            }
            
            .dropdown-item {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.75rem !important;
            }
            
            .dropdown-header {
                padding: 0.75rem !important;
                font-size: 0.75rem !important;
            }
            
            /* Perkecil ukuran modal buttons di mobile */
            .modal-close {
                top: 1rem;
                right: 1rem;
                width: 2.5rem;
                height: 2.5rem;
                font-size: 1rem;
            }
            
            .modal-nav {
                width: 2.75rem;
                height: 2.75rem;
                font-size: 1.25rem;
            }
            
            .modal-nav.prev {
                left: 1rem;
            }
            
            .modal-nav.next {
                right: 1rem;
            }
            
            .modal-download {
                width: 2.75rem;
                height: 2.75rem;
                font-size: 0.75rem;
            }
            
            .modal-download i {
                font-size: 1rem;
            }
            
            /* Adjust header layout for mobile */
            header .flex-col {
                gap: 0.75rem !important;
            }
        }
        
        /* PERUBAHAN: Untuk layar yang sangat kecil (iPhone SE dll) */
        @media (max-width: 374px) {
            .category-dropdown,
            .batch-dropdown {
                max-width: 120px;
            }
            
            #category-toggle,
            #batch-toggle {
                padding: 0.375rem 0.5rem !important;
                font-size: 0.6875rem !important;
            }
            
            #category-toggle i,
            #batch-toggle i {
                font-size: 0.6875rem !important;
            }
            
            #category-toggle span,
            #batch-toggle span {
                font-size: 0.6875rem !important;
            }
            
            #theme-toggle {
                width: 2.25rem !important;
                height: 2.25rem !important;
            }
            
            h1 {
                font-size: 1rem !important;
            }
            
            .header-logo {
                width: 20px !important;
                height: 20px !important;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 dark:from-gray-900 dark:to-gray-800 min-h-screen text-gray-900 dark:text-gray-100 transition-colors duration-300">

    <header class="glass-navbar sticky top-0 z-20 py-4 px-4 sm:px-6 mb-8 transition-all duration-300">
        <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-3 sm:gap-4">
            <!-- PERUBAHAN: Logo AnimeGallery dengan animasi looping terus-menerus -->
            <h1 class="text-xl sm:text-2xl font-bold text-gray-800 dark:text-white whitespace-nowrap flex items-center gap-2 mobile-logo">
                <lord-icon
                    src="https://cdn.lordicon.com/czcsywgo.json"
                    trigger="loop"
                    delay="2000"
                    colors="primary:#3b82f6,secondary:#8b5cf6"
                    class="header-logo mobile-header-logo"
                >
                </lord-icon>
                <span>Anime<span class="text-blue-600 dark:text-blue-400">Gallery</span></span>
            </h1>
            <div class="flex flex-wrap justify-end items-center gap-3 sm:gap-4 w-full sm:w-auto">
                <div class="flex items-center gap-2 sm:gap-4 flex-1 sm:flex-none justify-end">
                    <!-- PERUBAHAN: Dropdown untuk Batch Size -->
                    <div class="batch-dropdown w-full sm:w-40">
                        <button id="batch-toggle" class="w-full flex justify-between items-center px-4 py-2.5 glass-button rounded-xl text-sm font-medium transition-all duration-300 mobile-nav-button">
                            <span id="batch-selected" class="flex items-center gap-2.5">
                                <i class="fas fa-layer-group text-green-600 dark:text-green-400 text-sm"></i>
                                <span class="font-semibold">30 Images</span>
                            </span>
                            <i class="fas fa-chevron-down ml-2 text-xs transition-all duration-300"></i>
                        </button>
                        
                        <div id="batch-dropdown" class="dropdown-menu w-full mobile-dropdown">
                            <div class="dropdown-header flex items-center gap-2.5">
                                <i class="fas fa-sliders-h text-green-500"></i>
                                <span>Batch Size</span>
                            </div>
                            <div class="max-h-64 overflow-y-auto py-1">
                                <button class="dropdown-item active" data-value="30">
                                    <i class="fas fa-image text-green-500"></i>
                                    <span>30 Images</span>
                                </button>
                                <button class="dropdown-item" data-value="40">
                                    <i class="fas fa-images text-green-500"></i>
                                    <span>40 Images</span>
                                </button>
                                <button class="dropdown-item" data-value="50">
                                    <i class="fas fa-images text-green-500"></i>
                                    <span>50 Images</span>
                                </button>
                                <button class="dropdown-item" data-value="60">
                                    <i class="fas fa-images text-green-500"></i>
                                    <span>60 Images</span>
                                </button>
                                <button class="dropdown-item" data-value="70">
                                    <i class="fas fa-images text-green-500"></i>
                                    <span>70 Images</span>
                                </button>
                                <button class="dropdown-item" data-value="80">
                                    <i class="fas fa-images text-green-500"></i>
                                    <span>80 Images</span>
                                </button>
                                <button class="dropdown-item" data-value="90">
                                    <i class="fas fa-images text-green-500"></i>
                                    <span>90 Images</span>
                                </button>
                                <button class="dropdown-item" data-value="100">
                                    <i class="fas fa-images text-green-500"></i>
                                    <span>100 Images</span>
                                </button>
                                <button class="dropdown-item" data-value="110">
                                    <i class="fas fa-images text-green-500"></i>
                                    <span>110 Images</span>
                                </button>
                                <button class="dropdown-item" data-value="120">
                                    <i class="fas fa-images text-green-500"></i>
                                    <span>120 Images</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Custom Category Dropdown -->
                    <div class="category-dropdown w-full sm:w-52">
                        <button id="category-toggle" class="w-full flex justify-between items-center px-4 py-2.5 glass-button rounded-xl text-sm font-medium transition-all duration-300 mobile-nav-button">
                            <span id="category-selected" class="flex items-center gap-2.5">
                                <i class="fas fa-tag text-blue-600 dark:text-blue-400 text-sm"></i>
                                <span class="font-semibold">Waifu</span>
                            </span>
                            <i class="fas fa-chevron-down ml-2 text-xs transition-all duration-300"></i>
                        </button>
                        
                        <div id="category-dropdown" class="dropdown-menu w-full mobile-dropdown">
                            <div class="dropdown-header flex items-center gap-2.5">
                                <i class="fas fa-filter text-blue-500"></i>
                                <span>Pilih Kategori</span>
                            </div>
                            <div class="max-h-64 overflow-y-auto py-1">
                                <button class="dropdown-item active" data-value="waifu">
                                    <i class="fas fa-user text-blue-500"></i>
                                    <span>Waifu</span>
                                </button>
                                <button class="dropdown-item" data-value="neko">
                                    <i class="fas fa-cat text-yellow-500"></i>
                                    <span>Neko</span>
                                </button>
                                <button class="dropdown-item" data-value="shinobu">
                                    <i class="fas fa-ghost text-purple-500"></i>
                                    <span>Shinobu</span>
                                </button>
                                <button class="dropdown-item" data-value="megumin">
                                    <i class="fas fa-fire text-red-500"></i>
                                    <span>Megumin</span>
                                </button>
                                <button class="dropdown-item" data-value="bully">
                                    <i class="fas fa-fist-raised text-gray-500"></i>
                                    <span>Bully</span>
                                </button>
                                <button class="dropdown-item" data-value="cuddle">
                                    <i class="fas fa-heart text-pink-500"></i>
                                    <span>Cuddle</span>
                                </button>
                                <button class="dropdown-item" data-value="cry">
                                    <i class="fas fa-sad-tear text-blue-300"></i>
                                    <span>Cry</span>
                                </button>
                                <button class="dropdown-item" data-value="hug">
                                    <i class="fas fa-hands-helping text-green-500"></i>
                                    <span>Hug</span>
                                </button>
                                <button class="dropdown-item" data-value="awoo">
                                    <i class="fas fa-dog text-yellow-600"></i>
                                    <span>Awoo</span>
                                </button>
                                <button class="dropdown-item" data-value="kiss">
                                    <i class="fas fa-kiss text-red-400"></i>
                                    <span>Kiss</span>
                                </button>
                                <button class="dropdown-item" data-value="lick">
                                    <i class="fas fa-ice-cream text-pink-400"></i>
                                    <span>Lick</span>
                                </button>
                                <button class="dropdown-item" data-value="pat">
                                    <i class="fas fa-hand-paper text-orange-400"></i>
                                    <span>Pat</span>
                                </button>
                                <button class="dropdown-item" data-value="smug">
                                    <i class="fas fa-grin-tongue-wink text-teal-500"></i>
                                    <span>Smug</span>
                                </button>
                                <button class="dropdown-item" data-value="bonk">
                                    <i class="fas fa-hammer text-gray-700"></i>
                                    <span>Bonk</span>
                                </button>
                                <button class="dropdown-item" data-value="yeet">
                                    <i class="fas fa-running text-indigo-500"></i>
                                    <span>Yeet</span>
                                </button>
                                <button class="dropdown-item" data-value="blush">
                                    <i class="fas fa-flushed text-red-300"></i>
                                    <span>Blush</span>
                                </button>
                                <button class="dropdown-item" data-value="smile">
                                    <i class="fas fa-smile text-yellow-400"></i>
                                    <span>Smile</span>
                                </button>
                                <button class="dropdown-item" data-value="wave">
                                    <i class="fas fa-hand-paper text-blue-400"></i>
                                    <span>Wave</span>
                                </button>
                                <button class="dropdown-item" data-value="highfive">
                                    <i class="fas fa-hand-spock text-orange-500"></i>
                                    <span>Highfive</span>
                                </button>
                                <button class="dropdown-item" data-value="handhold">
                                    <i class="fas fa-hand-holding-heart text-pink-600"></i>
                                    <span>Handhold</span>
                                </button>
                                <button class="dropdown-item" data-value="nom">
                                    <i class="fas fa-utensils text-amber-600"></i>
                                    <span>Nom</span>
                                </button>
                                <button class="dropdown-item" data-value="bite">
                                    <i class="fas fa-tooth text-red-600"></i>
                                    <span>Bite</span>
                                </button>
                                <button class="dropdown-item" data-value="glomp">
                                    <i class="fas fa-hands text-purple-400"></i>
                                    <span>Glomp</span>
                                </button>
                                <button class="dropdown-item" data-value="slap">
                                    <i class="fas fa-hand-rock text-gray-800"></i>
                                    <span>Slap</span>
                                </button>
                                <button class="dropdown-item" data-value="kill">
                                    <i class="fas fa-skull-crossbones text-gray-900"></i>
                                    <span>Kill</span>
                                </button>
                                <button class="dropdown-item" data-value="kick">
                                    <i class="fas fa-shoe-prints text-amber-800"></i>
                                    <span>Kick</span>
                                </button>
                                <button class="dropdown-item" data-value="happy">
                                    <i class="fas fa-laugh-beam text-yellow-300"></i>
                                    <span>Happy</span>
                                </button>
                                <button class="dropdown-item" data-value="wink">
                                    <i class="fas fa-smile-wink text-blue-300"></i>
                                    <span>Wink</span>
                                </button>
                                <button class="dropdown-item" data-value="poke">
                                    <i class="fas fa-hand-point-up text-green-400"></i>
                                    <span>Poke</span>
                                </button>
                                <button class="dropdown-item" data-value="dance">
                                    <i class="fas fa-music text-purple-300"></i>
                                    <span>Dance</span>
                                </button>
                                <button class="dropdown-item" data-value="cringe">
                                    <i class="fas fa-grimace text-amber-800"></i>
                                    <span>Cringe</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PERUBAHAN: Tombol theme toggle dengan LordIcon animasi -->
                    <button id="theme-toggle" class="glass-button rounded-full w-12 h-12 flex items-center justify-center p-0 mobile-theme-button">
                        <div id="theme-icon-container">
                            <!-- Icon akan dimuat oleh JavaScript berdasarkan tema -->
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
        <div id="masonry-grid" class="masonry-wrapper">
            <!-- Kolom akan dibuat secara dinamis oleh JS -->
        </div>

        <div id="loading-indicator" class="flex flex-col items-center justify-center py-10">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 dark:border-blue-400 mb-4"></div>
            <div id="progress-text" class="text-sm font-medium text-gray-600 dark:text-gray-400">0%</div>
        </div>

        <div id="infinite-loader" class="flex flex-col items-center justify-center py-10">
            <div id="infinite-spinner" class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 dark:border-blue-400 mb-4 hidden"></div>
            <div id="infinite-progress" class="text-sm font-medium text-gray-600 dark:text-gray-400 hidden">0%</div>
        </div>
    </main>

    <!-- PERUBAHAN: Back to Top Button - menjadi bulat sempurna -->
    <button id="back-to-top" class="fixed bottom-8 right-8 z-30 bg-gradient-to-br from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white shadow-lg opacity-0 pointer-events-none transition-all duration-300">
        <i class="fas fa-arrow-up text-white text-lg"></i>
    </button>

    <!-- Image Preview Modal -->
    <div id="image-modal" class="image-modal">
        <div class="modal-content">
            <div id="modal-loading" class="modal-loading">
                <div class="modal-loading-spinner"></div>
            </div>
            
            <img id="modal-image" class="modal-image" src="" alt="" style="display: none;">
            
            <div class="modal-info">
                <div class="modal-title" id="modal-title"></div>
                <div class="modal-category" id="modal-category"></div>
            </div>
            
            <!-- PERUBAHAN: Tombol download di modal - menjadi bulat sempurna -->
            <a id="modal-download" class="modal-download" href="#" target="_blank" download title="Download Image">
                <i class="fas fa-download"></i>
                <span>Download</span>
            </a>
        </div>
        
        <!-- PERUBAHAN: Tombol close, prev, dan next dipindah ke luar modal-content agar posisinya fixed terhadap viewport -->
        <button id="modal-close" class="modal-close">
            <i class="fas fa-times"></i>
        </button>
        
        <button id="modal-prev" class="modal-nav prev">
            <i class="fas fa-chevron-left"></i>
        </button>
        
        <button id="modal-next" class="modal-nav next">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>

    <script>
        const gridWrapper = document.getElementById('masonry-grid');
        const initialLoader = document.getElementById('loading-indicator');
        const progressText = document.getElementById('progress-text');
        const infiniteLoader = document.getElementById('infinite-loader');
        const infiniteSpinner = document.getElementById('infinite-spinner');
        const infiniteProgress = document.getElementById('infinite-progress');
        const backToTop = document.getElementById('back-to-top');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIconContainer = document.getElementById('theme-icon-container');
        
        // Custom dropdown elements
        const categoryToggle = document.getElementById('category-toggle');
        const categoryDropdown = document.getElementById('category-dropdown');
        const categorySelected = document.getElementById('category-selected');
        const dropdownItems = document.querySelectorAll('#category-dropdown .dropdown-item');
        
        // Batch dropdown elements
        const batchToggle = document.getElementById('batch-toggle');
        const batchDropdown = document.getElementById('batch-dropdown');
        const batchSelected = document.getElementById('batch-selected');
        const batchItems = document.querySelectorAll('#batch-dropdown .dropdown-item');

        // Modal elements
        const imageModal = document.getElementById('image-modal');
        const modalClose = document.getElementById('modal-close');
        const modalImage = document.getElementById('modal-image');
        const modalTitle = document.getElementById('modal-title');
        const modalCategory = document.getElementById('modal-category');
        const modalPrev = document.getElementById('modal-prev');
        const modalNext = document.getElementById('modal-next');
        const modalLoading = document.getElementById('modal-loading');
        const modalDownload = document.getElementById('modal-download');

        const FALLBACK_IMAGE = 'https://i.waifu.pics/Weau1RP.jpg';
        const MAX_EXCLUDE = 1000; // Batas exclude untuk many endpoint agar tidak terlalu besar

        const seenUrls = new Set();

        let columns = [];
        let columnHeights = [];
        let currentColumnCount = 0;
        let itemNumber = 1;
        let loadedItems = []; // {card, ratio, url, index}
        let loading = false;
        let currentMode = 'sfw'; // Hanya SFW saja
        let currentCategory = 'waifu';
        let currentBatchSize = 30; // Default batch size
        let isCategoryDropdownOpen = false;
        let isBatchDropdownOpen = false;
        
        // Modal state
        let currentImageIndex = -1;
        let currentImages = []; // Store all image URLs for navigation
        
        // Theme icon elements
        let themeSunIcon = null;
        let themeMoonIcon = null;

        // Custom dropdown functionality
        function toggleCategoryDropdown() {
            isCategoryDropdownOpen = !isCategoryDropdownOpen;
            categoryDropdown.classList.toggle('open', isCategoryDropdownOpen);
            
            // Rotate arrow icon
            const arrow = categoryToggle.querySelector('.fa-chevron-down');
            arrow.style.transform = isCategoryDropdownOpen ? 'rotate(180deg)' : 'rotate(0deg)';
            
            // Close batch dropdown if open
            if (isBatchDropdownOpen) {
                closeBatchDropdown();
            }
        }

        function closeCategoryDropdown() {
            isCategoryDropdownOpen = false;
            categoryDropdown.classList.remove('open');
            
            // Rotate arrow icon back
            const arrow = categoryToggle.querySelector('.fa-chevron-down');
            arrow.style.transform = 'rotate(0deg)';
        }

        function toggleBatchDropdown() {
            isBatchDropdownOpen = !isBatchDropdownOpen;
            batchDropdown.classList.toggle('open', isBatchDropdownOpen);
            
            // Rotate arrow icon
            const arrow = batchToggle.querySelector('.fa-chevron-down');
            arrow.style.transform = isBatchDropdownOpen ? 'rotate(180deg)' : 'rotate(0deg)';
            
            // Close category dropdown if open
            if (isCategoryDropdownOpen) {
                closeCategoryDropdown();
            }
        }

        function closeBatchDropdown() {
            isBatchDropdownOpen = false;
            batchDropdown.classList.remove('open');
            
            // Rotate arrow icon back
            const arrow = batchToggle.querySelector('.fa-chevron-down');
            arrow.style.transform = 'rotate(0deg)';
        }

        function selectCategory(value, text) {
            currentCategory = value;
            categorySelected.innerHTML = `<i class="fas fa-tag text-blue-600 dark:text-blue-400 text-sm"></i><span class="font-semibold">${text}</span>`;
            
            // Update active state in dropdown
            dropdownItems.forEach(item => {
                if (item.dataset.value === value) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            closeCategoryDropdown();
            resetGrid();
            // Tampilkan loader untuk initial load
            initialLoader.classList.remove('hidden');
            progressText.textContent = '0%';
            loadBatch();
        }

        function selectBatchSize(value, text) {
            currentBatchSize = parseInt(value);
            batchSelected.innerHTML = `<i class="fas fa-layer-group text-green-600 dark:text-green-400 text-sm"></i><span class="font-semibold">${value} Images</span>`;
            
            // Update active state in dropdown
            batchItems.forEach(item => {
                if (item.dataset.value === value) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            closeBatchDropdown();
            
            // Reset grid dan load ulang dengan batch size baru
            resetGrid();
            initialLoader.classList.remove('hidden');
            progressText.textContent = '0%';
            loadBatch();
        }

        // Event listeners for custom dropdowns
        categoryToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleCategoryDropdown();
        });

        batchToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleBatchDropdown();
        });

        dropdownItems.forEach(item => {
            item.addEventListener('click', () => {
                const value = item.dataset.value;
                const text = item.querySelector('span').textContent;
                selectCategory(value, text);
            });
        });

        batchItems.forEach(item => {
            item.addEventListener('click', () => {
                const value = item.dataset.value;
                const text = item.querySelector('span').textContent;
                selectBatchSize(value, text);
            });
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!categoryToggle.contains(e.target) && !categoryDropdown.contains(e.target)) {
                closeCategoryDropdown();
            }
            if (!batchToggle.contains(e.target) && !batchDropdown.contains(e.target)) {
                closeBatchDropdown();
            }
        });

        // Close dropdowns on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (isCategoryDropdownOpen) {
                    closeCategoryDropdown();
                }
                if (isBatchDropdownOpen) {
                    closeBatchDropdown();
                }
            }
        });

        function getColumnCount() {
            const width = window.innerWidth;
            if (width < 640) return 2; // Minimal 2 kolom di mobile
            if (width < 1024) return 3;
            if (width < 1280) return 4;
            return 4;
        }

        function initColumns() {
            gridWrapper.innerHTML = '';
            const count = getColumnCount();
            currentColumnCount = count;
            columns = [];
            columnHeights = Array(count).fill(0);

            for (let i = 0; i < count; i++) {
                const col = document.createElement('div');
                col.className = 'masonry-column';
                gridWrapper.appendChild(col);
                columns.push(col);
            }
        }

        function getCurrentColumnWidth() {
            if (columns.length === 0) return 400;
            void gridWrapper.offsetHeight; // Force reflow
            const width = columns[0].offsetWidth;
            return width > 0 ? width : 400;
        }

        function createCard(index, imageUrl, paddingPercent) {
            const wrapper = document.createElement('div');
            wrapper.className = 'grid-item group cursor-pointer';
            wrapper.dataset.index = index - 1; // Store index for modal navigation
            wrapper.dataset.url = imageUrl;

            wrapper.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-sm hover:shadow-xl border border-gray-100 dark:border-gray-700 transition-all duration-300">
                    <div class="relative skeleton" style="padding-bottom: ${paddingPercent};">
                        <img 
                            src="${imageUrl}" 
                            alt="${currentCategory.charAt(0).toUpperCase() + currentCategory.slice(1)} ${index}"
                            class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-700"
                            onload="this.classList.remove('opacity-0'); this.parentElement.classList.remove('skeleton');"
                            onerror="this.src='${FALLBACK_IMAGE}';"
                            loading="lazy"
                        />
                        <div class="absolute inset-x-0 bottom-0 p-3 bg-gradient-to-t from-black/70 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <p class="text-white text-xs font-medium flex items-center gap-2">
                                <i class="fas fa-image text-xs"></i>
                                <span>${currentCategory.charAt(0).toUpperCase() + currentCategory.slice(1)} #${index}</span>
                            </p>
                        </div>
                        <!-- PERUBAHAN: Tombol preview menggunakan LordIcon di tengah - UKURAN DIPERKECIL DENGAN ANIMASI LOOPING -->
                        <div class="preview-overlay">
                            <div class="preview-icon-container">
                                <lord-icon
                                    src="https://cdn.lordicon.com/vgxjrbxm.json"
                                    trigger="loop"
                                    colors="primary:#ffffff,secondary:#ffffff"
                                    style="width:24px;height:24px">
                                </lord-icon>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add click event to open modal
            wrapper.addEventListener('click', () => {
                openModal(index - 1, imageUrl);
            });
            
            // PERUBAHAN: Kontrol animasi LordIcon saat hover pada gambar
            // Cari element LordIcon di dalam wrapper
            const lordIconElement = wrapper.querySelector('lord-icon');
            
            if (lordIconElement) {
                // Saat mouse masuk ke gambar, mainkan animasi
                wrapper.addEventListener('mouseenter', () => {
                    if (lordIconElement.playTrigger) {
                        lordIconElement.playTrigger();
                    }
                });
                
                // Saat mouse keluar dari gambar, hentikan animasi
                wrapper.addEventListener('mouseleave', () => {
                    if (lordIconElement.pauseTrigger) {
                        lordIconElement.pauseTrigger();
                    }
                });
                
                // Inisialisasi: pause animasi saat pertama kali dimuat
                setTimeout(() => {
                    if (lordIconElement.pauseTrigger) {
                        lordIconElement.pauseTrigger();
                    }
                }, 100);
            }
            
            return wrapper;
        }

        function updateProgress(current, total, isInfinite = false) {
            const percentage = Math.round((current / total) * 100);
            if (isInfinite) {
                infiniteProgress.textContent = `${percentage}%`;
            } else {
                progressText.textContent = `${percentage}%`;
            }
        }

        async function loadBatch() {
            if (loading) return;
            loading = true;
            
            // Tampilkan progress untuk infinite load
            if (initialLoader.classList.contains('hidden')) {
                infiniteSpinner.classList.remove('hidden');
                infiniteProgress.classList.remove('hidden');
            }

            const columnWidth = getCurrentColumnWidth();

            // Gunakan /many endpoint untuk performa optimal (batch size gambar sekaligus)
            const manyEndpoint = `https://api.waifu.pics/many/${currentMode}/${currentCategory}`;

            let urls = [];
            try {
                const exclude = Array.from(seenUrls).slice(-MAX_EXCLUDE);
                const response = await fetch(manyEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ exclude })
                });

                if (response.ok) {
                    const data = await response.json();
                    urls = data.files || [];
                }
            } catch (err) {
                console.warn('Many endpoint failed, falling back to single fetches');
            }

            // Jika many gagal atau kurang dari batch size, fallback ke single fetch satu per satu (dengan paralelisme terbatas)
            if (urls.length < currentBatchSize) {
                const remaining = currentBatchSize - urls.length;
                const singlePromises = [];
                for (let i = 0; i < remaining; i++) {
                    singlePromises.push(
                        fetch(`https://api.waifu.pics/${currentMode}/${currentCategory}`)
                            .then(res => res.ok ? res.json() : { url: FALLBACK_IMAGE })
                            .then(data => data.url || FALLBACK_IMAGE)
                    );
                }
                const fallbackUrls = await Promise.all(singlePromises);
                urls = urls.concat(fallbackUrls);
            }

            // Filter duplikat (safety) dan tambahkan ke seen
            urls = urls.filter(url => {
                if (seenUrls.has(url)) return false;
                seenUrls.add(url);
                return true;
            });

            // Preload semua ratio secara paralel dengan progress tracking
            let loadedCount = 0;
            const totalUrls = urls.length;
            
            // Update progress awal
            updateProgress(0, totalUrls, initialLoader.classList.contains('hidden'));

            const ratioPromises = urls.map(url => 
                new Promise(resolve => {
                    const img = new Image();
                    img.src = url;
                    img.onload = () => {
                        const r = img.naturalWidth > 0 ? img.naturalHeight / img.naturalWidth : 1.5;
                        loadedCount++;
                        updateProgress(loadedCount, totalUrls, initialLoader.classList.contains('hidden'));
                        resolve({ url, ratio: r });
                    };
                    img.onerror = () => {
                        loadedCount++;
                        updateProgress(loadedCount, totalUrls, initialLoader.classList.contains('hidden'));
                        resolve({ url, ratio: 1.5 });
                    };
                })
            );

            const itemsData = await Promise.all(ratioPromises);

            // Buat dan append card secara langsung (progresif)
            itemsData.forEach(({ url, ratio }) => {
                const displayHeight = Math.round(columnWidth * ratio);
                const paddingPercent = (ratio * 100).toFixed(4) + '%';

                const card = createCard(itemNumber, url, paddingPercent);
                const itemIndex = itemNumber - 1; // Store index for modal

                const shortestIndex = columnHeights.indexOf(Math.min(...columnHeights));
                columns[shortestIndex].appendChild(card);
                columnHeights[shortestIndex] += displayHeight + 16;

                loadedItems.push({ card, ratio, url, index: itemIndex });
                itemNumber++;
            });

            loading = false;
            
            // Sembunyikan loader dan reset progress
            if (initialLoader.classList.contains('hidden')) {
                infiniteSpinner.classList.add('hidden');
                infiniteProgress.classList.add('hidden');
                infiniteProgress.textContent = '0%';
            } else {
                // Ini adalah load pertama, sembunyikan initial loader
                initialLoader.classList.add('hidden');
            }
        }

        function resetGrid() {
            seenUrls.clear();
            loadedItems = [];
            itemNumber = 1;
            initColumns();
        }

        function rebalanceOnResize() {
            const newCount = getColumnCount();
            if (newCount === currentColumnCount) return;

            initColumns();

            const newColumnWidth = getCurrentColumnWidth();
            columnHeights = Array(newCount).fill(0);

            loadedItems.forEach(({ card, ratio }) => {
                const displayHeight = Math.round(newColumnWidth * ratio);
                const shortestIndex = columnHeights.indexOf(Math.min(...columnHeights));
                columns[shortestIndex].appendChild(card);
                columnHeights[shortestIndex] += displayHeight + 16;
            });
        }

        // Image Modal Functions
        function openModal(index, url) {
            currentImageIndex = index;
            currentImages = loadedItems.map(item => item.url);
            
            // Show loading spinner
            modalLoading.style.display = 'flex';
            modalImage.style.display = 'none';
            
            // Set modal content
            modalImage.src = url;
            modalTitle.textContent = `${currentCategory.charAt(0).toUpperCase() + currentCategory.slice(1)} #${index + 1}`;
            modalCategory.innerHTML = `<i class="fas fa-tag"></i> <span>Kategori: ${currentCategory.charAt(0).toUpperCase() + currentCategory.slice(1)}</span>`;
            modalDownload.href = url;
            modalDownload.download = `waifu-${currentCategory}-${index + 1}.jpg`;
            
            // Show modal
            imageModal.classList.add('active');
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
            
            // Update navigation buttons
            updateModalNavButtons();
            
            // Preload image
            const img = new Image();
            img.onload = () => {
                modalLoading.style.display = 'none';
                modalImage.style.display = 'block';
            };
            img.onerror = () => {
                modalLoading.style.display = 'none';
                modalImage.style.display = 'block';
                modalImage.src = FALLBACK_IMAGE;
            };
            img.src = url;
        }

        function closeModal() {
            imageModal.classList.remove('active');
            document.body.style.overflow = '';
        }

        function navigateModal(direction) {
            const newIndex = currentImageIndex + direction;
            
            if (newIndex >= 0 && newIndex < currentImages.length) {
                openModal(newIndex, currentImages[newIndex]);
            }
        }

        function updateModalNavButtons() {
            // Previous button
            if (currentImageIndex <= 0) {
                modalPrev.classList.add('disabled');
            } else {
                modalPrev.classList.remove('disabled');
            }
            
            // Next button
            if (currentImageIndex >= currentImages.length - 1) {
                modalNext.classList.add('disabled');
            } else {
                modalNext.classList.remove('disabled');
            }
        }

        // Theme toggle functions with LordIcon
        function createThemeIcons() {
            // Create sun icon
            themeSunIcon = document.createElement('lord-icon');
            themeSunIcon.setAttribute('src', 'https://cdn.lordicon.com/hhmetsna.json');
            themeSunIcon.setAttribute('trigger', 'in');
            themeSunIcon.setAttribute('delay', '1500');
            themeSunIcon.setAttribute('state', 'in-reveal');
            themeSunIcon.style.width = '24px';
            themeSunIcon.style.height = '24px';
            
            // Create moon icon
            themeMoonIcon = document.createElement('lord-icon');
            themeMoonIcon.setAttribute('src', 'https://cdn.lordicon.com/lyxnguso.json');
            themeMoonIcon.setAttribute('trigger', 'in');
            themeMoonIcon.setAttribute('delay', '1500');
            themeMoonIcon.setAttribute('state', 'in-reveal');
            themeMoonIcon.style.width = '24px';
            themeMoonIcon.style.height = '24px';
            
            // Clear container and add appropriate icon
            themeIconContainer.innerHTML = '';
            if (document.documentElement.classList.contains('dark')) {
                themeIconContainer.appendChild(themeMoonIcon);
            } else {
                themeIconContainer.appendChild(themeSunIcon);
            }
        }

        function updateTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            
            // Update theme icons
            themeIconContainer.innerHTML = '';
            if (isDark) {
                themeIconContainer.appendChild(themeMoonIcon);
                // Play moon animation
                if (themeMoonIcon) {
                    themeMoonIcon.playTrigger();
                }
            } else {
                themeIconContainer.appendChild(themeSunIcon);
                // Play sun animation
                if (themeSunIcon) {
                    themeSunIcon.playTrigger();
                }
            }
        }

        // Initialize theme
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const isDark = savedTheme === 'dark' || (savedTheme === null && prefersDark);

            if (isDark) {
                document.documentElement.classList.add('dark');
            }
            
            createThemeIcons();
            
            // Play initial animation
            if (isDark && themeMoonIcon) {
                setTimeout(() => {
                    themeMoonIcon.playTrigger();
                }, 100);
            } else if (!isDark && themeSunIcon) {
                setTimeout(() => {
                    themeSunIcon.playTrigger();
                }, 100);
            }
        }

        // Theme toggle event listener
        themeToggle.addEventListener('click', updateTheme);

        // Modal event listeners
        modalClose.addEventListener('click', closeModal);
        
        modalPrev.addEventListener('click', () => {
            if (currentImageIndex > 0) {
                navigateModal(-1);
            }
        });
        
        modalNext.addEventListener('click', () => {
            if (currentImageIndex < currentImages.length - 1) {
                navigateModal(1);
            }
        });
        
        // Close modal when clicking on backdrop
        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal || e.target.classList.contains('modal-content')) {
                closeModal();
            }
        });
        
        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (!imageModal.classList.contains('active')) return;
            
            if (e.key === 'Escape') {
                closeModal();
            } else if (e.key === 'ArrowLeft') {
                if (currentImageIndex > 0) {
                    navigateModal(-1);
                }
            } else if (e.key === 'ArrowRight') {
                if (currentImageIndex < currentImages.length - 1) {
                    navigateModal(1);
                }
            }
        });

        // Back to Top Button
        window.addEventListener('scroll', () => {
            if (window.scrollY > 400) {
                backToTop.classList.remove('opacity-0', 'pointer-events-none');
                backToTop.classList.add('opacity-100', 'pointer-events-auto');
            } else {
                backToTop.classList.add('opacity-0', 'pointer-events-none');
                backToTop.classList.remove('opacity-100', 'pointer-events-auto');
            }
        });

        backToTop.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Initial setup
        initTheme();
        initColumns();
        
        // Set kategori default dan load batch pertama
        selectCategory('waifu', 'Waifu');
        // Batch size sudah default 30

        // Setup IntersectionObserver untuk infinite scroll
        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && !loading) {
                loadBatch();
            }
        }, {
            root: null,
            threshold: 0,
            rootMargin: '300px'
        });

        observer.observe(infiniteLoader);

        // Resize handler
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(rebalanceOnResize, 300);
        });
    </script>
</body>
</html>
